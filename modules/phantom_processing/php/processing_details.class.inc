<?php
/**
 * Endpoint for phantom_processing
 *
 * PHP Version 7
 *
 * @category   Endpoint
 * @package    Imaging
 * @subpackage Processing
 * @author     Xavier Lecours Boucher <xavier.lecoursboucher@mcgill.ca>
 * @license    http://www.gnu.org/licenses/gpl-3.0.txt GPLv3
 * @link       https://www.github.com/aces/Loris-Trunk/
 */
namespace LORIS\phantom_processing;

use \Psr\Http\Message\ServerRequestInterface;
use \Psr\Http\Message\ResponseInterface;
use \Psr\Http\Server\RequestHandlerInterface;
use \LORIS\server_processes_manager\ServerProcessLauncher;
use \LORIS\server_processes_manager\ServerProcessesMonitor;
use \Swagger\Client\Model\CbrainTask;

/**
 * Endpoint handler for phantom_processing
 *
 * PHP Version 7
 *
 * @category   Endpoint
 * @package    Imaging
 * @subpackage Processing
 * @author     Xavier Lecours Boucher <xavier.lecoursboucher@mcgill.ca>
 * @license    http://www.gnu.org/licenses/gpl-3.0.txt GPLv3
 * @link       https://www.github.com/aces/Loris-Trunk/
 */
class Processing_Details extends \NDB_Page
{
    public $skipTemplate = true;

    protected $timepoint;

    /**
     * Returns false if user does not have access to page.
     *
     * @return bool
     */
    function _hasAccess()
    {
        return \NDB_Factory::singleton()
            ->user()
            ->hasPermission('phantom_processing');
    }

    /**
     * An NDB_Page can act as both a middleware, or a handler, depending on the
     * context. When treated as a middleware, the page is responsible for setting
     * up any middleware required to access the page. By default, this will
     * implement the page decoration middlewares which is responsible for adding
     * the LORIS menu's/headers/footers/etc.
     * This can be overridden by modules who don't want this behaviour (such
     * as API endpoints).
     *
     * @param ServerRequestInterface  $request The PSR7 request being processed.
     * @param RequestHandlerInterface $handler The handler to handle the request
     *                                         after processing the middleware.
     *
     * @return ResponseInterface the PSR15 response that was generated by the
     * middleware
     */
    public function process(
        ServerRequestInterface $request,
        RequestHandlerInterface $handler
    ) : ResponseInterface {
        $this->timepoint = \TimePoint::singleton(
            $request->getQueryParams()['sessionid'] ?? null
        );

        $accept = $request->getHeaderLine('Accept');
        if (preg_match('/application\/json/', $accept) === 1) {
            return $this->handle($request)
                ->withHeader('Content-Type', 'application/json');
        }

        $request = $request->withAttribute(
            'pageclass',
            $this
        );
        $user    = $request->getAttribute("user");
        return (new \LORIS\Middleware\PageDecorationMiddleware($user))
            ->process(
                $request,
                new \LORIS\Http\StringStream('')
            )->withHeader("Content-Type", "text/html");
    }

    /**
     * Handles a request and produces a response.
     *
     * @param ServerRequestInterface $request The PSR7 request being processed.
     *
     * @return ResponseInterface the PSR15 response
     */
    public function handle(ServerRequestInterface $request): ResponseInterface
    {
        switch($request->getMethod()) {
        case 'POST':
            return $this->handlePOST($request);

        case 'GET':
        default:
            return $this->handleGET($request);
        }
    }

    /**
     * Specialized handler for GET requests
     *
     * @param ServerRequestInterface $request The PSR7 request being processed.
     *
     * @return ResponseInterface the PSR15 response
     */
    public function handleGET(ServerRequestInterface $request): ResponseInterface
    {
        return (new \Zend\Diactoros\Response())
            ->withBody(
                new \LORIS\Http\StringStream($this->toJSON())
            );
    }

    /**
     * Specialized handler for POST requests that launch a phantom_pipeline
     * using the server process manager module.
     *
     * @param ServerRequestInterface $request The PSR7 request being processed.
     *
     * @return ResponseInterface the PSR15 response
     */
    public function handlePOST(ServerRequestInterface $request): ResponseInterface
    {
        $spm_module        = \Module::factory('server_processes_manager');
        $server_process_id = (new ServerProcessLauncher())->legoPhantomPipeline(
            $this->timepoint
        );
        do {
            $process_state = (new ServerProcessesMonitor())
                ->getProcessesState(array($server_process_id));
        } while (trim($process_state[0]['STATE']) === 'RUNNING');

        // TODO :: an array with error and data would be better
        return (new \Zend\Diactoros\Response())
            ->withBody(
                new \LORIS\Http\StringStream(
                    json_encode($process_state[0]['STATE'])
                )
            )
            ->withStatus(200);
    }

    /**
     * Returns a json string representation of this page's data
     *
     * @return string
     */
    protected function toJSON(): string
    {
        return json_encode($this->toArray());
    }

    /**
     * Returns an array representation of this page's data
     *
     * @return array
     */
    protected function toArray(): array
    {

        $isPhantom   = $this->_isPhantomSession();
        $runs        = [];
        $filesStatus = [];

        if ($isPhantom) {
            $MySQLAccessor = new PhantomProcessMySQLAccessor(
                \NDB_Factory::singleton()->database()
            );

            $processes = $MySQLAccessor->getSessionServerProcesses(
                $this->timepoint
            );

            $runs = array_map(
                function ($p) {
                    if ($p['exit_code'] != '0') {
                        $p['cbraintask'] = '{"error": "no task"}';
                        return $p;
                    }

                    $fileinfo = new \SplFileInfo($p['stdout_file']);
                    if (!$fileinfo->isReadable()) {
                        $p['cbraintask'] = '{"error": ' .
                            '"Process output file not readable"}';
                        return $p;
                    }

                    $fileobject = $fileinfo->openFile();

                    $arr        = json_decode(
                        $fileobject->fread($fileobject->getSize()),
                        JSON_OBJECT_AS_ARRAY
                    );
                    $task       = new CbrainTask($arr);
                    $hook       = \LORIS\CbrainHook::getInstance();
                    $p['cbraintask'] = (string) $hook->updateTask($task);
                    return $p;
                },
                $processes
            );

            $filesStatus = $this->_getFilesStatus();
        }

        return array(
                'isPhantom' => $isPhantom,
                'timepoint' => $this->timepoint->_timePointInfo,
                'filesStatus' => $filesStatus, 
                'runs'      => $runs,
               );
    }

    /**
     * Utility function that tells if this timepoint is a phantom
     *
     * @return bool
     */
    private function _isPhantomSession(): bool
    {
        // This should be done from the Timepoint
        $entity_type = \NDB_Factory::singleton()
            ->candidate($this->timepoint->getCandID())
            ->getData('Entity_type');

        return $entity_type == 'Scanner';
    }

    /**
     * Checks if this timepoint scans have been uploaded and if they are visible
     * by cbrain.
     *
     * @return \stdClass
     */
    private function _getFilesStatus(): \stdClass
    {
        //TODO CBRIAN could throw an Exception if the fileInfo is not found....
        
        $hook = \LORIS\CbrainHook::getInstance();
        $obj = array(
            'localfileinfo' => new \SPLFileinfo('/data/loris/data/assembly/484341/lego_phantom_L1_UBC_20170307'),
            'cbrainfileinfo' => $hook->getFileinfoFromDataProviderByFilename(
                $hook->getInputDataProvider(),
                '484341_lego_phantom_L1_UBC_20170307'
            )
        );
        return (object) $obj;
    }
    /**
     * Overrides base getJSDependencies()
     *
     * @return array of extra JS files that this page depends on
     */
    function getJSDependencies()
    {
        $factory = \NDB_Factory::singleton();
        $baseURL = $factory->settings()->getBaseURL();
        $deps    = parent::getJSDependencies();
        return array_merge(
            $deps,
            array(
             $baseURL . "/phantom_processing/js/processingDetailsIndex.js",
            )
        );
    }


}

